name: test

on:
  - push
  - pull_request

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup go
        uses: https://github.com/actions/setup-go@v5
        with:
          go-version: '>=1.23.0'

      - name: Get dependencies
        run: >-
          apt-get update &&
          apt-get install -y
          gcc
          pkg-config
          libacl1-dev
        if: ${{ runner.os == 'Linux' }}

      - name: Run tests
        run: >-
          go test ./...

      - name: Build for Linux
        run: >-
          go build -v -ldflags '-s -w
          -X git.ophivana.moe/security/fortify/internal.Version=${{ github.ref_name }}
          -X git.ophivana.moe/security/fortify/internal.Fsu=/usr/bin/fsu
          -X git.ophivana.moe/security/fortify/internal.Finit=/usr/libexec/fortify/finit
          -X main.Fmain=/usr/bin/fortify
          -X main.Fshim=/usr/libexec/fortify/fshim'
          -o bin/ ./... &&
          (cd bin && sha512sum --tag -b * > sha512sums)
